<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SIGMA : Spatio-temporal Integrated Grid Map Analyzer </title>

<!-- Libraries -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://cdn.plot.ly/plotly-2.24.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>

<style>
  :root{ --bg:#f6f7fb; --panel:#ffffff; --accent:#074364ff; --muted:#6b7280; }
  /* Splash / intro styles */
  #splash {
    position: fixed; inset: 0; display:flex;align-items:center;justify-content:center;
    background: linear-gradient(180deg, #071233 0%, #0b4a6b 100%);
    color: #ffffff; z-index: 9999; transition: opacity .6s ease, visibility .6s ease;
  }
  #splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
  #splash .splash-inner{ text-align:center; }
  #splash h1{ font-size:56px; margin:0 0 8px; letter-spacing:1px; font-weight:700 }
  #splash p{ margin:0; opacity:0.9; font-size:18px }

  /* per-letter animation */
  .splash-letter{ display:inline-block; opacity:0; transform:translateY(8px); }
  @keyframes letterIn { from { opacity:0; transform:translateY(8px);} to { opacity:1; transform:translateY(0);} }
  .splash-sub{ display:block; opacity:0; transform:translateY(12px); }
  @keyframes subIn { from { opacity:0; transform:translateY(12px);} to { opacity:1; transform:translateY(0);} }

  /* Entry animation for containers */
  .animate-target{ opacity:0; transform: translateY(12px); transition: opacity .9s cubic-bezier(.2,.9,.2,1), transform .9s cubic-bezier(.2,.9,.2,1); }
  .animate-target.enter{ opacity:1; transform: translateY(0); }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:var(--bg);color:#111}
  header{background:#071233;color:#fff;padding:12px 18px;display:flex;align-items:center;gap:12px}
  header h1{margin:0;font-size:16px}
  .container{display:flex;flex-direction:column;height:calc(100% - 56px)}
  .top{display:flex;flex:1;gap:12px;padding:12px}
  .center{flex:1;background:var(--panel);border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(8,18,40,0.06);display:flex;flex-direction:column;gap:10px}
  .right{width:30%;min-width:300px;max-width:520px;background:var(--panel);border-radius:10px;padding:10px;box-shadow:0 6px 18px rgba(8,18,40,0.06);display:flex;flex-direction:column;gap:12px;max-height:86vh;overflow:auto}
  #mapWrap{flex:1;display:flex;flex-direction:column;gap:8px;max-height:520px}
  #map{height:420px;border-radius:8px;overflow:hidden}
  .controls{display:flex;gap:8px;align-items:center}
  .controls label{font-size:13px;color:var(--muted)}
  .panelSmall{background:#fbfdff;border-radius:8px;padding:8px}
  #cubePlot{height:320px;width:100%}
  #smallGrid{display:flex;flex-direction:column;gap:8px;overflow:auto}
  .accordion-item{border-radius:6px;border:1px solid #eef2f7;background:#fff;overflow:hidden}
  .accordion-header{display:flex;justify-content:space-between;align-items:center;padding:8px 10px;cursor:pointer}
  .accordion-body{display:none;padding:6px 10px;border-top:1px solid #f1f5f9}
  .sm-item{height:160px;background:#ffffff;border-radius:6px;padding:6px;box-shadow:inset 0 0 6px rgba(2,6,23,0.03)}
  .bottom{padding:12px;display:flex;grid-template-columns:520px 1fr;gap:12px}
  .chartWrap{background:var(--panel);padding:10px;border-radius:10px;box-shadow:0 6px 18px rgba(8,18,40,0.04)}
  .tabs{display:flex;gap:8px;margin-bottom:8px}
  .tab{padding:6px 10px;border-radius:6px;background:#f3f4f6;cursor:pointer;font-size:13px}
  .tab.active{background:var(--accent);color:#fff}
  .notice{color:#b91c1c;font-size:13px}
  footer{padding:8px 12px;font-size:12px;color:var(--muted)}
  select,input[type=range]{padding:6px;border-radius:6px;border:1px solid #e6e9ef}
  button{padding:6px 10px;border-radius:6px;border:0;background:var(--accent);color:#fff;cursor:pointer}
  .muted{color:var(--muted);font-size:13px}
  .year-buttons{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
  .year-buttons button{padding:6px 8px;background:#fff;color:#111;border:1px solid #e6e9ef;border-radius:6px;cursor:pointer}
  .year-buttons button.active{background:var(--accent);color:#fff;border-color:var(--accent)}
  #timeSlider{width:100%;margin-top:8px}
  .site-footer {
  background: #071233;
  color: #fff;
  text-align: center;
  padding: 10px 0;
  font-size: 14px;
  margin-top: 10px;
  border-top: 2px solid rgba(255,255,255,0.1);
}
</style>
</head>
<body>

<!-- Splash intro -->
<div id="splash">
  <div class="splash-inner">
    <h1 id="splashTitle">
      <span class="splash-letter" data-i="0">S</span>
      <span class="splash-letter" data-i="1">I</span>
      <span class="splash-letter" data-i="2">G</span>
      <span class="splash-letter" data-i="3">M</span>
      <span class="splash-letter" data-i="4">A</span>
    </h1>
    <p id="splashSubtitle" class="splash-sub">Spatio-temporal Integrated Grid Map Analyzer</p>
  </div>
</div>


<header>
  <h1>SIGMA : Spatio-temporal Integrated Grid Map Analyzer </h1>
  <div id="csvInfo" style="margin-left:auto;font-size:13px;opacity:.85">Sumber data: <code style="background:#0b1220;padding:2px 6px;border-radius:4px;margin-left:6px">Tolong Upload File CSV</code></div>
</header>

<div class="container">
  <div class="top">
    <div class="center">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div>
          <strong> Time-enabled map</strong>
          <div class="muted">Slider + Play/Pause â€” step cepat (200â€“300 ms), size by confidence</div>
        </div>
        <div class="controls">
          <label>Step (ms)</label>
          <input id="speed" type="range" min="50" max="1000" value="250" style="width:140px">
          <label>Trail</label>
          <input id="trailLen" type="range" min="1" max="10" value="1" style="width:120px">
          <button id="btnPlay">Play</button>
          <button id="btnReset">Reset</button>
        </div>
      </div>
      <div style="margin:12px 0 8px 0; display:flex; gap:8px; align-items:center;">
        <input type="file" id="csvInput" accept=".csv" style="display:none">
        <button id="btnUploadCSV" style="background:var(--accent);color:#fff;border:none;padding:7px 16px;border-radius:6px;cursor:pointer;font-weight:500;">Upload CSV</button>
        <span id="csvFileName" class="muted"></span>
      </div>

      <div id="mapWrap" class="panelSmall" >
        <div id="map" ></div>

        <!-- Time slider + controls -->
        <input type="range" id="timeSlider" min="0" max="1" value="0" />
        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:6px">
          <div class="muted" id="timeLabel">â€”</div>
          <div class="muted">Menampilkan: <span id="visibleCount">0</span> titik kejadian Â· MA: <span id="movAvg">0</span></div>
        </div>
      </div>
    </div>

    <aside class="right">
      <div>
        <strong>Space-Time Cube</strong>
        <div class="muted">Rotate / zoom untuk eksplorasi</div>
        <div id="cubePlot" style="height:320px;margin-top:8px"></div>
      </div>

      <div>
        <div style="display:flex;justify-content:space-between;align-items:center">
          <div><strong>Grid Time-Series</strong><div class="muted">Pilih tahun lalu buka bulan</div></div>
          <div>
            <select id="yearSelect"></select>
          </div>
        </div>

        <div style="margin-top:8px;display:flex;gap:8px">
          <button id="toggleGridBtn">Tampilkan Grid </button>
        </div>

        <div id="small-multiples-container" style="display:none;margin-top:8px">
          <div id="smallGrid" ></div>
        </div>
      </div>

    </aside>
  </div>

  <div class="bottom">
    <div class="chartWrap" style="height:520px;">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Grafik Kejadian per Waktu</strong>
        <div style="display:flex;gap:10px">
          <div class="tabs">
            <div class="tab active" data-tab="monthly">Bulanan</div>
            <div class="tab" data-tab="daily">Harian</div>
            <div class="tab" data-tab="yearly">Tahunan</div>
          </div>
        </div>
      </div>

      <div id="chartMonthly" style="height:100%;margin-top:8px"></div>
      <div id="chartDaily" style="height:100%;margin-top:8px;display:none"></div>
      <div id="chartYearly" style="height:100%;margin-top:8px;display:none"></div>
    </div>

    <div class="chartWrap">
      <strong>Heatmap Per Tahun</strong>
      <div class="muted">Klik tahun untuk render heatmap tahunan</div>
      <div id="yearButtons" class="year-buttons"></div>
      <div id="heatmap" style="height:520px;margin-top:8px"></div>
    </div>
  </div>

<div id="summaryBox"
     style="padding:15px; background:#fafafa; border-radius:6px; margin-top:20px;">
</div>


  <footer>
    <div id="notes" class="notice"></div>
  </footer>

<footer class="site-footer">
  Â© 2025 â€¢ SIGMA â€¢ Developed by <strong>Ageng - Dela - Fika - Lita</strong>
</footer>

</div>

<script>
/* CSV path (local) */
const CSV_PATH = "api_kutai_with_lonlat.csv";

/* Utilities */
function parseDateISO(s){
  if(!s) return null;
  // Coba parse langsung
  let t = s.trim();
  let d = new Date(t.replace(/\//g,'-') + 'T00:00:00Z');
  if (!isNaN(d.getTime())) return d;
  // Fallback: format M/D/YYYY atau MM/DD/YYYY
  const mdy = t.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
  if (mdy) {
    // Bulan -1 karena JS bulan 0-based
    return new Date(Date.UTC(Number(mdy[3]), Number(mdy[1])-1, Number(mdy[2])));
  }
  // Fallback: format YYYY-MM-DD
  const ymd = t.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
  if (ymd) {
    return new Date(Date.UTC(Number(ymd[1]), Number(ymd[2])-1, Number(ymd[3])));
  }
  return null;
}
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function safeNum(v,def=NaN){ const n = Number(v); return isNaN(n)?def:n; }

/* Global state */
let RAW = [];
let DATA = [];
let BASE_DATE = null;
let mapObj = null;
let heatMapInstance = null;
let timelineMaxDay = 0;

function updateInsightBox(dailyCounts){
  const summaryBox = document.getElementById("summaryBox");
  const days = Object.keys(dailyCounts).sort();
  const values = days.map(d => dailyCounts[d]);

  if(values.length === 0){
    summaryBox.innerHTML = '<div class="summary-container"><strong>Leaflet</strong><br>Tidak ada data kejadian.</div>';
    return;
  }

  const maxVal = Math.max(...values);
  const maxDay = days[values.indexOf(maxVal)];
  const avg = values.reduce((a,b)=>a+b,0) / values.length;
  const aboveAvg = values.filter(v => v > avg).length;

  summaryBox.innerHTML = `
    <div class="summary-container" style="background:#fff; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.06); padding:18px; margin-bottom:8px; text-align:center;">
      <div style="font-weight:bold; font-size:15px; margin-bottom:6px;">KESIMPULAN</div>
      <div style="font-size:16px; margin-bottom:8px;">ðŸ”¥ Insight dari data:</div>
      <div style="font-size:14px; color:#222;">
        Puncak kejadian tertinggi terjadi pada <strong>${maxDay}</strong> (${maxVal} titik).<br>
        Rata-rata kejadian harian: <strong>${avg.toFixed(2)}</strong> titik.<br>
        Jumlah hari dengan kejadian di atas rata-rata: <strong>${aboveAvg}</strong> hari.<br>
        Total hari tercatat: <strong>${values.length}</strong> hari.
      </div>
    </div>
  `;
}

function bootstrapAll(){

  // ============================
  // 1. Hitung dailyCounts dulu
  // ============================
  const dailyCounts = {};
  DATA.forEach(d => {
    const key = d.date.toISOString().slice(0,10);
    dailyCounts[key] = (dailyCounts[key] || 0) + 1;
  });

  // ============================
  // 2. Panggil insight otomatis
  // ============================
  updateInsightBox(dailyCounts);

  // ============================
  // 3. Lanjut fungsi existing
  // ============================
  // document.getElementById('summaryBox').innerText = '';
  buildMap();
  buildCube();
  buildYearSelector();
  buildBottomCharts();
  buildYearButtons();
  buildHeatControls();
}

/* Load CSV */
function loadCSV(input){
  // input bisa berupa path string (default) atau File object (upload)
  if (typeof input === 'string') {
    Papa.parse(input, {
      download:true, header:true, dynamicTyping:true,
      complete: handleCSVResult,
      error: (err)=>{ document.getElementById('notes').innerText = 'Gagal load CSV: ' + err; }
    });
  } else if (input instanceof File) {
    Papa.parse(input, {
      header:true, dynamicTyping:true,
      complete: handleCSVResult,
      error: (err)=>{ document.getElementById('notes').innerText = 'Gagal load CSV: ' + err; }
    });
  }
}

function handleCSVResult(res) {
  if(!res || !res.data || res.data.length===0){
    document.getElementById('notes').innerText = 'CSV kosong atau gagal di-parse.';
    return;
  }
  // Deteksi nama kolom yang umum
  function getField(obj, keys) {
    for (let k of keys) {
      if (obj[k] !== undefined && obj[k] !== null && obj[k] !== "") return obj[k];
    }
    return undefined;
  }

  let errorRows = [];
  RAW = res.data.map((r, idx) => {
    // Ambil field dengan fallback beberapa nama
    const date = getField(r, ["ACQ_DATE", "date", "Date", "tanggal"]);
    const lat = getField(r, ["latitude", "lat", "LAT", "Latitude"]);
    const lon = getField(r, ["longitude", "lon", "LON", "LONGITUDE", "Longitude"]);
    // Cek validitas
    const isEmptyRow = Object.values(r).every(v => v === null || v === undefined || v === "");
    if (!isEmptyRow && (!date || (!lon && lon !== 0) || (!lat && lat !== 0))) {
      errorRows.push({row: idx+2, reason: `Missing field: ${!date?'date ':''}${!lat?'lat ':''}${!lon?'lon ':''}`});
    }
    return { ...r, _date: date, _lat: lat, _lon: lon };
  }).filter(r => r._date && (r._lon || r._lon===0) && (r._lat || r._lat===0));

  if(RAW.length===0){
    let msg = 'CSV tidak mengandung baris yang valid.';
    if (errorRows.length > 0) {
      msg += '<br>Baris yang gagal:<br>' + errorRows.slice(0,10).map(e => `Baris ${e.row}: ${e.reason}`).join('<br>');
      if (errorRows.length > 10) msg += `<br>...dan ${errorRows.length-10} baris lain.`;
    }
    document.getElementById('notes').innerHTML = msg;
    return;
  }
  // Hanya tampilkan notifikasi jika ada errorRows selain baris kosong
  if (errorRows.length > 0) {
    let msg = `Ada ${errorRows.length} baris yang gagal diproses.<br>Contoh:<br>` + errorRows.slice(0,5).map(e => `Baris ${e.row}: ${e.reason}`).join('<br>');
    document.getElementById('notes').innerHTML = msg;
  } else {
    document.getElementById('notes').innerText = '';
  }
  preprocess();
  bootstrapAll();
}

/* Preprocess */
function preprocess(){
  DATA = RAW.map(r=>{
    // Ambil field dengan fallback beberapa nama
    const date = parseDateISO(r._date) || (r.date ? new Date(r.date) : null);
    const year = safeNum(r.YEAR, r.year, r.tahun) || (date?date.getUTCFullYear():null);
    const month = safeNum(r.MONTH, r.month, r.bulan) || (date?date.getUTCMonth()+1:null);
    const lon = safeNum(r._lon, r.longitude, r.LON, r.LONGITUDE, r.lon);
    const lat = safeNum(r._lat, r.latitude, r.LAT, r.lat);
    const conf = safeNum(r.CONFIDENCE, r.conf, r.confidence, r.kepercayaan, 50);
    return { raw:r, date, year:year, month:month, longitude:lon, latitude:lat, confidence:conf };
  }).filter(d => d.date && Number.isFinite(d.longitude) && Number.isFinite(d.latitude));

  DATA.sort((a,b)=>a.date - b.date);
  BASE_DATE = DATA[0].date;
  DATA.forEach(d => d.dayIndex = Math.round((d.date - BASE_DATE)/(1000*60*60*24)));
  timelineMaxDay = Math.max(...DATA.map(d=>d.dayIndex));
}


/* Map + Time slider + Play/Pause */
function buildMap(){
  mapObj = L.map('map',{preferCanvas:true}).setView([0.8,117.0],8);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:18}).addTo(mapObj);

  // group by dayIndex
  const byDay = {};
  DATA.forEach(d=>{
    if(!byDay[d.dayIndex]) byDay[d.dayIndex]=[];
    byDay[d.dayIndex].push(d);
  });
  const maxDay = timelineMaxDay || 0;

  // set slider
  const slider = document.getElementById('timeSlider');
  slider.min = 0;
  slider.max = Math.max(0, maxDay);
  slider.value = 0;

  const markers = L.layerGroup().addTo(mapObj);
  let playInterval = null;
  let currentDay = 0;

  const visibleCountEl = document.getElementById('visibleCount');
  const timeLabelEl = document.getElementById('timeLabel');
  const movAvgEl = document.getElementById('movAvg');

  function drawDay(dayIndex){
    markers.clearLayers();
    let total = 0;
    const trail = Number(document.getElementById('trailLen').value) || 1;

    for(let t=0; t<trail; t++){
      const idx = dayIndex - t;
      if(idx < 0) continue;
      const pts = byDay[idx] || [];
      pts.forEach(p=>{
        total++;
        const r = clamp(2 + (p.confidence/100)*6, 2, 12);
        L.circleMarker([p.latitude, p.longitude], {
          radius: r,
          fillOpacity: 1.0,
          stroke: false,
          fillColor: (p.confidence >= 80 ? '#b30000' : (p.confidence >= 60 ? '#ff3300' : '#ff8c00'))
        }).addTo(markers);
      });
    }

    visibleCountEl.innerText = total;
    const dayDate = new Date(BASE_DATE.getTime() + dayIndex*24*3600*1000);
    timeLabelEl.innerText = dayDate.toISOString().slice(0,10) + ' (dayIndex ' + dayIndex + ')';

    // moving avg last 7 days
    let sum=0,cnt=0;
    for(let i=0;i<7;i++){ const idx = dayIndex-i; if(idx<0) break; sum += (byDay[idx]||[]).length; cnt++; }
    movAvgEl.innerText = cnt?Math.round(sum/cnt):0;

    // sync slider value
    slider.value = dayIndex;
  }

  // slider manual input
  slider.addEventListener('input', ()=> {
    const day = Number(slider.value);
    currentDay = day;
    drawDay(day);
  });

  // play/pause
  document.getElementById('btnPlay').onclick = ()=>{
    const btn = document.getElementById('btnPlay');
    if(playInterval){
      clearInterval(playInterval); playInterval = null; btn.innerText = 'Play';
    } else {
      const ms = clamp(Number(document.getElementById('speed').value), 20, 5000);
      playInterval = setInterval(()=>{
        currentDay++;
        if(currentDay > maxDay) currentDay = 0;
        drawDay(currentDay);
      }, ms);
      btn.innerText = 'Pause';
    }
  };

  document.getElementById('btnReset').onclick = ()=>{
    if(playInterval){ clearInterval(playInterval); playInterval = null; document.getElementById('btnPlay').innerText='Play'; }
    currentDay = 0; drawDay(0);
  };

  // initial draw
  drawDay(0);
}

/* Space-Time Cube */
function buildCube(){
  try{ Plotly.purge('cubePlot'); }catch(e){}
  Plotly.newPlot('cubePlot',[{
    x: DATA.map(d=>d.longitude),
    y: DATA.map(d=>d.latitude),
    z: DATA.map(d=>d.dayIndex),
    mode: 'markers',
    type: 'scatter3d',
    marker: { size: 3, color: DATA.map(d=>d.confidence), colorscale: 'Hot', showscale:true }
  }], { margin:{l:0,r:0,t:0,b:0}, scene:{ xaxis:{title:'Lon'}, yaxis:{title:'Lat'}, zaxis:{title:'DayIndex'} } }, {responsive:true});
}

/* Small multiples accordion */
function buildYearSelector(){
  const years = Array.from(new Set(DATA.map(d=>d.year))).filter(y=>y).sort((a,b)=>a-b);
  const sel = document.getElementById('yearSelect');
  sel.innerHTML = '';
  years.forEach(y=>{ const o=document.createElement('option'); o.value=y; o.textContent=y; sel.appendChild(o);} );
  if(years.length>0) sel.value = years[0];
  sel.onchange = ()=> {
    const container = document.getElementById('small-multiples-container');
    if(container.style.display === 'block') buildSmallMultiples();
  };
}

function buildSmallMultiples(){
  const sel = document.getElementById('yearSelect');
  const year = Number(sel.value);
  const grid = document.getElementById('smallGrid');
  grid.innerHTML = '';

  const lons = DATA.map(d=>d.longitude); const lats = DATA.map(d=>d.latitude);
  const minLon = Math.min(...lons), maxLon = Math.max(...lons);
  const minLat = Math.min(...lats), maxLat = Math.max(...lats);

  const monthNames = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

  for(let m=1;m<=12;m++){
    const item = document.createElement('div'); item.className='accordion-item';
    const header = document.createElement('div'); header.className='accordion-header';
    header.innerHTML = `<div><strong>${monthNames[m-1]}</strong> â€” ${DATA.filter(d=>d.year===year && d.month===m).length} events</div><div class="muted">â–¶</div>`;
    const body = document.createElement('div'); body.className='accordion-body';
    const plotId = 'plot_' + year + '_' + m;
    body.innerHTML = `<div id="${plotId}" style="height:140px;"></div>`;
    item.appendChild(header); item.appendChild(body);
    grid.appendChild(item);

    header.addEventListener('click', ()=>{
      const open = body.style.display === 'block';
      if(open){
        body.style.display = 'none';
        header.querySelector('.muted').innerText = 'â–¶';
      } else {
        body.style.display = 'block';
        header.querySelector('.muted').innerText = 'â–¼';
        if(!body.dataset.rendered){
          const pts = DATA.filter(d=>d.year===year && d.month===m);
          Plotly.newPlot(plotId, [{ x: pts.map(p=>p.longitude), y: pts.map(p=>p.latitude), mode:'markers', type:'scattergl', marker:{size:4} }],
            { margin:{l:20,r:10,t:6,b:6}, xaxis:{range:[minLon,maxLon],visible:false}, yaxis:{range:[minLat,maxLat],visible:false} },
            {displayModeBar:false,staticPlot:true});
          body.dataset.rendered = '1';
        }
      }
    });
  }
}

/* Bottom charts */
function buildBottomCharts(){
  const byMonth = {};
  DATA.forEach(d=>{
    const k = d.year + '-' + String(d.month).padStart(2,'0');
    byMonth[k] = (byMonth[k]||0) + 1;
  });
  const months = Object.keys(byMonth).sort();
  Plotly.newPlot('chartMonthly',[{x:months,y:months.map(k=>byMonth[k]),mode:'lines+markers'}],{margin:{l:40,r:10,t:6,b:40}},{responsive:true});

  const byDay = {};
  DATA.forEach(d=>{ const k = d.date.toISOString().slice(0,10); byDay[k] = (byDay[k]||0)+1; });
  const days = Object.keys(byDay).sort();
  Plotly.newPlot('chartDaily',[{x:days,y:days.map(k=>byDay[k]),mode:'lines'}],{margin:{l:40,r:10,t:6,b:40}},{responsive:true});

  const byYear = {};
  DATA.forEach(d=>{ byYear[d.year] = (byYear[d.year]||0)+1; });
  const yrs = Object.keys(byYear).sort();
  Plotly.newPlot('chartYearly',[{x:yrs,y:yrs.map(k=>byYear[k]),type:'bar'}],{margin:{l:40,r:10,t:6,b:40}},{responsive:true});

  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick = ()=>{
      document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
      t.classList.add('active');
      const tab = t.dataset.tab;
      document.getElementById('chartMonthly').style.display = (tab==='monthly') ? '' : 'none';
      document.getElementById('chartDaily').style.display = (tab==='daily') ? '' : 'none';
      document.getElementById('chartYearly').style.display = (tab==='yearly') ? '' : 'none';
      // resize Plotly when visibility changes
      try{ Plotly.Plots.resize(document.getElementById('chartMonthly')); }catch(e){}
      try{ Plotly.Plots.resize(document.getElementById('chartDaily')); }catch(e){}
      try{ Plotly.Plots.resize(document.getElementById('chartYearly')); }catch(e){}
    };
  });
}

/* Heatmap per year: buttons */
function buildYearButtons(){
  const years = Array.from(new Set(DATA.map(d=>d.year))).filter(y=>y).sort((a,b)=>a-b);
  const container = document.getElementById('yearButtons');
  container.innerHTML = '';
  years.forEach(y=>{
    const btn = document.createElement('button');
    btn.textContent = y;
    btn.dataset.year = y;
    btn.onclick = ()=>{
      // set active class
      container.querySelectorAll('button').forEach(b=>b.classList.remove('active'));
      btn.classList.add('active');
      renderHeatmapYear(Number(btn.dataset.year));
    };
    container.appendChild(btn);
  });
  // set default active to earliest or 2001 if present
  const defaultYear = years.includes(2001)?2001: (years.length?years[0]:null);
  if(defaultYear) {
    // click programmatically to render
    const btn = container.querySelector(`button[data-year="${defaultYear}"]`);
    if(btn) btn.click();
  }
}

/* Render heatmap for a specific year (very bold) */
function renderHeatmapYear(year){
  const container = document.getElementById('heatmap');
  container.innerHTML = '';
  const mapDiv = document.createElement('div'); mapDiv.style.height='100%'; mapDiv.style.width='100%';
  container.appendChild(mapDiv);

  setTimeout(()=>{
    try{ if(heatMapInstance) heatMapInstance.remove(); }catch(e){}
    heatMapInstance = L.map(mapDiv,{preferCanvas:true}).setView([0.8,117.0],8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(heatMapInstance);
    const pts = DATA.filter(d=>d.year===year).map(p=>[p.latitude,p.longitude, 1.0]);
    L.heatLayer(pts, {
      radius: 40,
      blur: 30,
      maxZoom: 12,
      gradient: {0.0: 'rgba(0,0,0,0)', 0.25:'#fff7bc', 0.5:'#fec44f', 0.75:'#fe9929', 1.0:'#cc0018'}
    }).addTo(heatMapInstance);
    setTimeout(()=> heatMapInstance.invalidateSize(), 80);

    // Tambahkan legenda heatmap
    const legend = L.control({position: 'bottomright'});
    legend.onAdd = function (map) {
      const div = L.DomUtil.create('div', 'info legend');
      div.style.background = '#fff';
      div.style.padding = '8px';
      div.style.borderRadius = '6px';
      div.style.boxShadow = '0 2px 8px rgba(0,0,0,0.12)';
      div.style.fontSize = '13px';
      div.innerHTML += '<b>Heatmap Intensity</b><br>';
      div.innerHTML += '<div style="display:flex;align-items:center;gap:4px;margin-top:4px">'
        + '<span style="width:18px;height:18px;background:#fff7bc;display:inline-block;border-radius:3px;border:1px solid #eee"></span> Rendah'
        + '</div>';
      div.innerHTML += '<div style="display:flex;align-items:center;gap:4px;margin-top:2px">'
        + '<span style="width:18px;height:18px;background:#fec44f;display:inline-block;border-radius:3px;border:1px solid #eee"></span> Sedang'
        + '</div>';
      div.innerHTML += '<div style="display:flex;align-items:center;gap:4px;margin-top:2px">'
        + '<span style="width:18px;height:18px;background:#fe9929;display:inline-block;border-radius:3px;border:1px solid #eee"></span> Tinggi'
        + '</div>';
      div.innerHTML += '<div style="display:flex;align-items:center;gap:4px;margin-top:2px">'
        + '<span style="width:18px;height:18px;background:#cc0018;display:inline-block;border-radius:3px;border:1px solid #eee"></span> Sangat Tinggi'
        + '</div>';
      return div;
    };
    legend.addTo(heatMapInstance);
  },60);
}

/* UI: toggle accordion container */
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'toggleGridBtn'){
    const box = document.getElementById('small-multiples-container');
    const btn = e.target;
    const isHidden = box.style.display === 'none' || box.style.display === '';
    if(isHidden){
      buildSmallMultiples();
      box.style.display = 'block';
      btn.innerText = 'Sembunyikan Grid';
    } else {
      box.style.display = 'none';
      btn.innerText = 'Tampilkan Grid (Accordion)';
    }
  }
});

/* Start */
// Data hanya akan divisualisasikan setelah user upload CSV

// Event handler upload CSV
document.addEventListener('DOMContentLoaded', function() {
  const btnUpload = document.getElementById('btnUploadCSV');
  const inputFile = document.getElementById('csvInput');
  const fileNameSpan = document.getElementById('csvFileName');
  const csvInfo = document.getElementById('csvInfo');

  btnUpload.onclick = function() {
    inputFile.click();
  };

  inputFile.onchange = function(e) {
    if (inputFile.files && inputFile.files[0]) {
      fileNameSpan.textContent = inputFile.files[0].name;
      loadCSV(inputFile.files[0]);
      csvInfo.innerHTML = 'CSV: <code style="background:#0b1220;padding:2px 6px;border-radius:4px;margin-left:6px">' + inputFile.files[0].name + '</code>';
    }
  };
});

// Splash handling and entry animations
document.addEventListener('DOMContentLoaded', function() {
  const splash = document.getElementById('splash');
  const targets = [
    document.querySelector('header'),
    document.getElementById('mapWrap'),
    document.getElementById('cubePlot'),
    document.querySelector('.right'),
    ...Array.from(document.querySelectorAll('.chartWrap')),
    document.getElementById('summaryBox')
  ].filter(Boolean);

  // mark targets as animate-target
  targets.forEach(t => t.classList.add('animate-target'));

  // animate splash letters and subtitle, then hide splash and animate targets
  const letters = Array.from(document.querySelectorAll('.splash-letter'));
  const subtitle = document.getElementById('splashSubtitle');
  // per-letter animation settings
  const letterDur = 700; // ms
  const letterStagger = 120; // ms
  letters.forEach((sp, i) => {
    sp.style.animation = `letterIn ${letterDur}ms cubic-bezier(.2,.9,.2,1) forwards`;
    sp.style.animationDelay = `${i * letterStagger}ms`;
  });
  // subtitle appears after last letter
  if (subtitle) {
    const subDelay = letters.length * letterStagger + 150; // ms
    subtitle.style.animation = `subIn 800ms cubic-bezier(.2,.9,.2,1) forwards`;
    subtitle.style.animationDelay = `${subDelay}ms`;
  }

  // total splash show time (letters + subtitle + small pause)
  const totalSplash = letters.length * letterStagger + letterDur + 800; // ms
  setTimeout(() => {
    if (splash) splash.classList.add('hidden');
    // start animating targets shortly after splash fades
    setTimeout(() => {
      targets.forEach((el, i) => {
        setTimeout(() => {
          el.classList.add('enter');
          try{ Plotly.Plots.resize(el.querySelector('.js-plotly-plot') || document.getElementById('chartMonthly')); }catch(e){}
          try{ if (heatMapInstance) heatMapInstance.invalidateSize(); }catch(e){}
        }, i * 140);
      });
    }, 300);
  }, totalSplash);
});

</script>
</body>
</html>
